<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oasis Contable PWA</title>

  <!-- Manifest + tema -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0d12">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- Iconos básicos -->
  <link rel="icon" href="assets/icons/icon-192.png" type="image/png">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">

  <!-- Estilos -->
  <link rel="stylesheet" href="styles.css" />

  <!-- CDNs requeridos -->
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <!-- Aviso de actualización (SW) -->
  <div id="update-banner" class="update-banner hidden">
    Nueva versión disponible.
    <button id="btn-refresh" class="btn btn-gold">Actualizar</button>
  </div>

  <!-- Vista de LOGIN -->
  <main id="login-view" class="centered">
    <div class="card glass login-card">
      <img id="login-logo" src="assets/logo.png" alt="Logo" class="logo" />
      <h1 class="title">Acceso</h1>

      <div class="pin-box">
        <label>PIN (4–6 dígitos)</label>
        <input id="pin-input" inputmode="numeric" maxlength="6" minlength="4" placeholder="****" />
        <div class="muted" id="pin-attempts">Intentos restantes: 5</div>
        <button id="btn-pin-login" class="btn btn-primary">Entrar con PIN</button>
      </div>

      <div class="or">o</div>

      <button id="btn-google" class="btn btn-secondary">Entrar con Google</button>
      <div id="login-error" class="error"></div>
    </div>
  </main>

  <!-- SHELL APP -->
  <div id="app-shell" class="app hidden">
    <aside class="sidebar">
      <div class="company">
        <img id="company-logo" src="assets/logo.png" alt="Logo" class="logo small" />
        <div id="company-name">Mi Empresa</div>
      </div>
      <nav>
        <button class="nav-link active" data-target="dashboard">Dashboard</button>
        <button class="nav-link" data-target="payroll">Nómina</button>
        <button class="nav-link" data-target="ledger">Libro Mayor</button>
        <button class="nav-link" data-target="settings">Configuración</button>
        <button class="nav-link danger" id="btn-logout">Salir</button>
      </nav>
    </aside>

    <section class="content">
      <!-- DASHBOARD -->
      <section id="view-dashboard" class="view">
        <h2>Dashboard</h2>
        <div class="kpi-grid">
          <div class="card glass"><div class="kpi-title">Ingresos (mes)</div><div id="kpi-income" class="kpi-value">—</div></div>
          <div class="card glass"><div class="kpi-title">Gastos (mes)</div><div id="kpi-expenses" class="kpi-value">—</div></div>
          <div class="card glass"><div class="kpi-title">Nómina (mes)</div><div id="kpi-payroll" class="kpi-value">—</div></div>
        </div>

        <div class="charts">
          <div class="card glass">
            <h3>Flujo mensual (Ingresos vs Gastos)</h3>
            <canvas id="chart-flow" height="110"></canvas>
          </div>
          <div class="card glass">
            <h3>Gastos por categoría (Top 6)</h3>
            <canvas id="chart-cats" height="110"></canvas>
          </div>
        </div>
      </section>

      <!-- NÓMINA -->
      <section id="view-payroll" class="view hidden">
        <div class="flex-between">
          <h2>Nómina</h2>
          <div class="row-gap">
            <button id="btn-payroll-export" class="btn btn-gold">Exportar PDF</button>
            <button id="btn-payroll-backup" class="btn">Backup JSON</button>
            <input type="file" id="payroll-restore" class="file" accept="application/json" />
          </div>
        </div>

        <div class="card glass">
          <form id="payroll-form" class="grid-5">
            <input id="pr-employee" placeholder="Empleado" required />
            <input id="pr-date" type="date" required />
            <input id="pr-gross" type="number" step="0.01" placeholder="Sueldo bruto" required />
            <input id="pr-ret" type="number" step="0.01" placeholder="Retención %" value="10" required />
            <input id="pr-dedu1" type="number" step="0.01" placeholder="Deducción % (opcional)" />
            <button class="btn btn-primary" type="submit">Agregar</button>
          </form>
          <div class="muted">Neto = bruto × (1 − retención/100 − deducción/100)</div>
        </div>

        <div class="card glass">
          <table class="table" id="payroll-table">
            <thead>
              <tr>
                <th>Empleado</th><th>Fecha</th><th>Bruto</th><th>Retención %</th><th>Deducción %</th><th>Neto</th><th></th>
              </tr>
            </thead>
            <tbody id="payroll-tbody"></tbody>
          </table>
        </div>
      </section>

      <!-- LIBRO MAYOR -->
      <section id="view-ledger" class="view hidden">
        <div class="flex-between">
          <h2>Libro mayor</h2>
          <div class="row-gap">
            <button id="btn-ledger-export" class="btn btn-gold">Exportar PDF</button>
            <button id="btn-ledger-backup" class="btn">Backup JSON</button>
            <input type="file" id="ledger-restore" class="file" accept="application/json" />
          </div>
        </div>

        <div class="card glass">
          <form id="ledger-form" class="grid-5">
            <select id="lg-type">
              <option value="ingreso">Ingreso</option>
              <option value="gasto">Gasto</option>
            </select>
            <input id="lg-desc" placeholder="Descripción" required />
            <input id="lg-amount" type="number" step="0.01" placeholder="Monto" required />
            <input id="lg-date" type="date" required />
            <input id="lg-category" placeholder="Categoría (opcional)" />
            <button class="btn btn-primary" type="submit">Agregar</button>
          </form>
        </div>

        <div class="card glass">
          <table class="table" id="ledger-table">
            <thead>
              <tr>
                <th>Tipo</th><th>Descripción</th><th>Monto</th><th>Fecha</th><th>Categoría</th><th></th>
              </tr>
            </thead>
            <tbody id="ledger-tbody"></tbody>
          </table>
        </div>
      </section>

      <!-- CONFIGURACIÓN -->
      <section id="view-settings" class="view hidden">
        <h2>Configuración</h2>
        <div class="grid-2">
          <div class="card glass">
            <h3>Empresa</h3>
            <label>Nombre</label>
            <input id="set-company" placeholder="Nombre de empresa" />
            <label>Logo (Storage)</label>
            <input id="set-logo" type="file" accept="image/*" />
            <button id="btn-save-company" class="btn btn-primary">Guardar</button>
          </div>

          <div class="card glass">
            <h3>PIN</h3>
            <label>Nuevo PIN (4–6)</label>
            <input id="set-pin" inputmode="numeric" maxlength="6" minlength="4" />
            <button id="btn-save-pin" class="btn">Cambiar PIN</button>
            <div class="muted">El PIN se guarda localmente y en Firestore (cifrado SHA-256).</div>
          </div>

          <div class="card glass">
            <h3>Backup general</h3>
            <button id="btn-backup-all" class="btn">Exportar JSON</button>
            <input id="restore-all" type="file" class="file" accept="application/json"/>
          </div>

          <div class="card glass">
            <h3>Instalación</h3>
            <button id="btn-install" class="btn btn-gold hidden">Instalar PWA</button>
            <div class="muted">Si no ves el botón, tu navegador no expuso el prompt aún.</div>
          </div>
        </div>
      </section>
    </section>
  </div>

  <!-- Offline fallback simple -->
  <noscript>Esta app requiere JavaScript</noscript>

  <!-- Scripts de app -->
  <script defer src="firebase.js"></script>
  <script defer src="app.js"></script>
</body>
</html>
